<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#e91e63">
    <title>ポケモン検索</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .search-container {
            text-align: center;
            margin: 20px 0;
            position: relative;
            margin-bottom: 20px;
        }
        #searchInput {
            padding: 10px;
            font-size: 16px;
            width: 200px;
            border: 2px solid #3b4cca;
            border-radius: 5px;
        }
        #searchButton, #randomButton {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #3b4cca;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
        }
        #searchButton:hover, #randomButton:hover {
            background-color: #2a3899;
        }
        #result {
            text-align: center;
            margin-top: 20px;
        }
        .pokemon-card {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .cry-button {
            background-color: #3b4cca;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 10px auto;
        }
        .cry-button:hover {
            background-color: #2a3899;
        }
        .cry-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .cry-button svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }
        .type-label {
            display: inline-block;
            padding: 3px 10px;
            margin: 2px;
            border-radius: 15px;
            color: white;
            font-size: 14px;
        }
        .evolution-chain {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .evolution-chain-separator {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
            color: #3b4cca;
        }
        .evolution-card {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 150px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .evolution-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .evolution-arrow {
            font-size: 24px;
            color: #3b4cca;
        }
        .current-pokemon {
            border: 3px solid #3b4cca;
        }
        .forms-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        .form-sprite {
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: transform 0.2s;
        }
        .form-sprite:hover {
            transform: scale(1.1);
            background-color: #f0f0f0;
        }
        .form-sprite.active {
            background-color: #e0e0ff;
            border: 2px solid #3b4cca;
        }
        .sprite-container {
            position: relative;
            display: inline-block;
        }
        .form-name {
            font-size: 12px;
            margin-top: 5px;
        }
        #main-sprite {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #main-sprite img {
            width: 150px;
            height: 150px;
            object-fit: contain;
        }
        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .suggestion-item:hover {
            background-color: #f0f0f0;
        }
        .suggestion-item .number {
            color: #666;
            font-size: 0.9em;
            margin-right: 8px;
            min-width: 50px;
        }
        .install-button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #3b4cca;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
        }
        .install-button:hover {
            background-color: #2a3899;
        }
        .varieties-container {
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .varieties {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        
        .variety-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            width: 120px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .variety-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .variety-card img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }
        
        .variety-card p {
            margin: 5px 0 0;
            font-size: 12px;
        }
        
        .current-form {
            border-color: #e91e63;
            background-color: rgba(233, 30, 99, 0.1);
        }
        
        .sprite-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .main-sprite {
            margin-bottom: 10px;
        }
        
        .main-sprite img {
            width: 200px;
            height: 200px;
            object-fit: contain;
        }
        
        .sprite-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        .sprite-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sprite-thumbnail:hover {
            transform: scale(1.1);
        }
        
        .sprite-thumbnail.active {
            border-color: #e91e63;
            background-color: rgba(233, 30, 99, 0.1);
        }
        
        .pokemon-details-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            gap: 20px;
            width: 100%;
        }
        
        .pokemon-id {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
            background-color: #f2f2f2;
            padding: 5px 10px;
            border-radius: 5px;
            min-width: 80px;
            text-align: center;
        }
        
        .pokemon-types {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .type-badge {
            display: inline-block;
            padding: 3px 10px;
            margin: 2px;
            border-radius: 15px;
            color: white;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="search-container">
        <h1>ポケモン検索</h1>
        <input type="text" id="searchInput" placeholder="図鑑番号（1-1025）または名前を入力">
        <div class="suggestions" id="suggestions"></div>
        <button id="searchButton">検索</button>
        <button id="randomButton">ランダム表示</button>
        <button class="install-button" style="display: none;">アプリをインストール</button>
    </div>
    <div id="result"></div>

    <script>
        // サービスワーカーの登録
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker 登録成功:', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker 登録失敗:', error);
                    });
            });
        }

        // PWAインストールプロンプト
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // インストールプロンプトを表示しない
            e.preventDefault();
            // イベントを保存
            deferredPrompt = e;
            // インストールボタンを表示
            document.querySelector('.install-button').style.display = 'block';
        });

        document.querySelector('.install-button').addEventListener('click', () => {
            // ボタンを非表示
            document.querySelector('.install-button').style.display = 'none';
            // インストールプロンプトを表示
            deferredPrompt.prompt();
            // ユーザーの選択を待つ
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('ユーザーがインストールを承認しました');
                } else {
                    console.log('ユーザーがインストールを拒否しました');
                }
                deferredPrompt = null;
            });
        });

        // タイプごとの背景色
        const typeColors = {
            normal: '#A8A878',
            fire: '#F08030',
            water: '#6890F0',
            electric: '#F8D030',
            grass: '#78C850',
            ice: '#98D8D8',
            fighting: '#C03028',
            poison: '#A040A0',
            ground: '#E0C068',
            flying: '#A890F0',
            psychic: '#F85888',
            bug: '#A8B820',
            rock: '#B8A038',
            ghost: '#705898',
            dragon: '#7038F8',
            dark: '#705848',
            steel: '#B8B8D0',
            fairy: '#EE99AC'
        };

        // ポケモンの日本語名と英語名のマッピング
        let pokemonNameMapping = {};
        let pokemonSuggestions = [];
        let isInitialized = false;
        let isInitializing = false;

        // キャッシュの有効期限（1週間）
        const CACHE_EXPIRY = 7 * 24 * 60 * 60 * 1000;
        const CACHE_KEY = 'pokemonCache_v2'; // バージョン管理のためのキー

        // 初期化関数
        async function initializePokemonNames() {
            if (isInitialized) return;
            if (isInitializing) {
                // 既に初期化中の場合は完了を待つ
                await waitForInitialization();
                return;
            }

            isInitializing = true;
            
            try {
                // キャッシュをチェック
                const cache = loadFromCache();
                if (cache) {
                    console.log('キャッシュからデータを読み込みました');
                    pokemonNameMapping = cache.nameMapping;
                    pokemonSuggestions = cache.suggestions;
                    isInitialized = true;
                    isInitializing = false;
                    return;
                }

                // キャッシュがない場合はAPIから取得
                console.log('APIからデータを取得中...');
                await fetchPokemonData();
                
                // キャッシュに保存
                saveToCache({
                    nameMapping: pokemonNameMapping,
                    suggestions: pokemonSuggestions,
                    timestamp: Date.now()
                });
                
                isInitialized = true;
                console.log('ポケモンデータの初期化が完了しました');
            } catch (error) {
                console.error('ポケモンデータの初期化に失敗しました:', error);
            } finally {
                isInitializing = false;
            }
        }

        // 初期化完了を待つヘルパー関数
        function waitForInitialization() {
            return new Promise(resolve => {
                const checkInterval = setInterval(() => {
                    if (!isInitializing) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
            });
        }

        // APIからポケモンデータを取得
        async function fetchPokemonData() {
            const response = await fetch('https://pokeapi.co/api/v2/pokemon-species?limit=1500');
            const data = await response.json();
            
            // バッチ処理で取得（一度に全部取得するとエラーになる可能性があるため）
            const batchSize = 50;
            for (let i = 0; i < data.results.length; i += batchSize) {
                const batch = data.results.slice(i, i + batchSize);
                await Promise.all(batch.map(async pokemon => {
                    try {
                        const speciesResponse = await fetch(pokemon.url);
                        const speciesData = await speciesResponse.json();
                        const japaneseName = speciesData.names.find(name => name.language.name === 'ja')?.name;
                        if (japaneseName) {
                            pokemonNameMapping[japaneseName.toLowerCase()] = pokemon.name;
                            
                            // ポケモンの基本情報だけを取得（画像なし）
                            const pokemonResponse = await fetch(`https://pokeapi.co/api/v2/pokemon/${pokemon.name}`);
                            const pokemonData = await pokemonResponse.json();
                            pokemonSuggestions.push({
                                id: pokemonData.id,
                                name: japaneseName,
                                englishName: pokemon.name
                            });
                        }
                    } catch (error) {
                        console.error(`${pokemon.name}の取得に失敗しました:`, error);
                    }
                }));
                
                // 進捗状況を表示
                console.log(`ポケモンデータ取得中: ${Math.min(i + batchSize, data.results.length)}/${data.results.length}`);
            }
            
            // IDでソート
            pokemonSuggestions.sort((a, b) => a.id - b.id);
        }

        // キャッシュから読み込む
        function loadFromCache() {
            try {
                const cache = JSON.parse(localStorage.getItem(CACHE_KEY));
                if (!cache) return null;

                // キャッシュの有効期限をチェック
                if (Date.now() - cache.timestamp > CACHE_EXPIRY) {
                    console.log('キャッシュの有効期限が切れました');
                    localStorage.removeItem(CACHE_KEY);
                    return null;
                }

                return cache;
            } catch (error) {
                console.error('キャッシュの読み込みに失敗しました:', error);
                localStorage.removeItem(CACHE_KEY);
                return null;
            }
        }

        // キャッシュに保存
        function saveToCache(data) {
            try {
                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                console.log('データをキャッシュに保存しました');
            } catch (error) {
                console.error('キャッシュの保存に失敗しました:', error);
                // ストレージ容量の問題の場合、古いキャッシュをクリア
                if (error.name === 'QuotaExceededError') {
                    localStorage.clear();
                    try {
                        localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                        console.log('ストレージをクリアして再保存しました');
                    } catch (e) {
                        console.error('再保存にも失敗しました');
                    }
                }
            }
        }

        // キャッシュをクリア
        function clearCache() {
            localStorage.removeItem(CACHE_KEY);
            console.log('キャッシュをクリアしました');
            location.reload(); // ページを再読み込み
        }

        // 検索時に日本語名を英語名に変換
        async function searchPokemon() {
            const searchInput = document.getElementById('searchInput').value.trim();
            
            if (!searchInput) return;
            
            // 数字の場合はそのまま検索
            if (!isNaN(searchInput)) {
                fetchPokemon(searchInput);
                return;
            }
            
            // 日本語名のマッピングを初期化
            if (!isInitialized) {
                document.getElementById('result').innerHTML = '<p>ポケモンデータを読み込み中...</p>';
                await initializePokemonNames();
            }
            
            // 日本語名を英語名に変換して検索
            const englishName = pokemonNameMapping[searchInput.toLowerCase()];
            if (englishName) {
                fetchPokemon(englishName);
            } else {
                // 英語名でも試してみる
                fetchPokemon(searchInput.toLowerCase());
            }
        }

        // 検索候補を表示する関数
        function showSuggestions(input) {
            const suggestionsDiv = document.getElementById('suggestions');
            if (!input) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            const inputValue = input.toLowerCase();
            
            // 重複を避けるため、IDとnameでユニークな候補を作成
            const uniqueMatches = new Map();
            
            pokemonSuggestions.forEach(pokemon => {
                if (
                    pokemon.name.toLowerCase().includes(inputValue) || 
                    pokemon.id.toString().includes(inputValue)
                ) {
                    // IDをキーとして使用することで、同じポケモンは上書きされる
                    uniqueMatches.set(pokemon.id, pokemon);
                }
            });

            // Map から配列に変換して最初の10件を取得
            const matches = Array.from(uniqueMatches.values())
                .sort((a, b) => {
                    // 入力値が数字の場合はIDでソート
                    if (!isNaN(inputValue)) {
                        return a.id - b.id;
                    }
                    // 名前での検索の場合は、一致度でソート
                    const aStartsWith = a.name.toLowerCase().startsWith(inputValue);
                    const bStartsWith = b.name.toLowerCase().startsWith(inputValue);
                    if (aStartsWith && !bStartsWith) return -1;
                    if (!aStartsWith && bStartsWith) return 1;
                    return a.id - b.id;
                })
                .slice(0, 10);

            if (matches.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            const html = matches.map(pokemon => `
                <div class="suggestion-item" onclick="selectPokemon('${pokemon.englishName}', '${pokemon.name}')">
                    <span class="number">#${pokemon.id.toString().padStart(4, '0')}</span>
                    <span>${pokemon.name}</span>
                </div>
            `).join('');

            suggestionsDiv.innerHTML = html;
            suggestionsDiv.style.display = 'block';
        }

        // 候補を選択したときの処理
        function selectPokemon(englishName, japaneseName) {
            document.getElementById('searchInput').value = japaneseName;
            document.getElementById('suggestions').style.display = 'none';
            fetchPokemon(englishName);
        }

        document.getElementById('searchButton').addEventListener('click', searchPokemon);
        document.getElementById('randomButton').addEventListener('click', getRandomPokemon);
        document.getElementById('searchInput').addEventListener('input', function(e) {
            if (!isInitialized) {
                document.getElementById('result').innerHTML = '<p>ポケモンデータを読み込み中...</p>';
                initializePokemonNames().then(() => showSuggestions(e.target.value));
            } else {
                showSuggestions(e.target.value);
            }
        });
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchPokemon();
            }
        });

        // クリック以外の場所をクリックしたときに候補を非表示にする
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                document.getElementById('suggestions').style.display = 'none';
            }
        });

        // ページ読み込み時にランダムポケモンを表示
        window.addEventListener('load', getRandomPokemon);

        async function fetchPokemon(identifier) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>読み込み中...</p>';
            
            try {
                // PokeAPIからポケモンデータを取得
                const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${identifier}`);
                
                if (!response.ok) {
                    // 通常の検索で見つからない場合、種族名で検索
                    const speciesResponse = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${identifier}`);
                    if (!speciesResponse.ok) {
                        throw new Error('ポケモンが見つかりませんでした');
                    }
                    
                    const speciesData = await speciesResponse.json();
                    // デフォルトのポケモンを取得
                    const defaultVarietyUrl = speciesData.varieties.find(v => v.is_default).pokemon.url;
                    const defaultPokemonResponse = await fetch(defaultVarietyUrl);
                    const data = await defaultPokemonResponse.json();
                    await displayPokemonData(data, speciesData);
                    return;
                }
                
                const data = await response.json();
                
                // 種族データを取得
                const speciesResponse = await fetch(data.species.url);
                const speciesData = await speciesResponse.json();
                
                await displayPokemonData(data, speciesData);
            } catch (error) {
                console.error('Error fetching Pokemon:', error);
                resultDiv.innerHTML = '<p>ポケモンが見つかりませんでした。正しい名前または図鑑番号を入力してください。</p>';
            }
        }

        async function displayPokemonData(data, speciesData) {
            const resultDiv = document.getElementById('result');
            
            // 日本語の名前を取得
            const japaneseName = speciesData.names.find(name => name.language.name === 'ja')?.name || data.name;
            
            // 日本語のフレーバーテキストを取得
            const japaneseFlavorText = speciesData.flavor_text_entries.find(entry => entry.language.name === 'ja')?.flavor_text || '';
            
            // タイプ情報を取得
            const typeHtml = data.types.map(typeInfo => {
                const type = typeInfo.type.name;
                return `<span class="type-badge" style="background-color: ${typeColors[type]};">${getTypeInJapanese(type)}</span>`;
            }).join(' ');
            
            // スプライトを取得（通常、ガラル、アローラなど）
            const allSprites = getAllSprites(data.sprites, data.types);
            
            // フォームバリエーションを取得
            const varieties = await getVarieties(speciesData, data.id);
            
            // 進化チェーンを取得
            const evolutionResponse = await fetch(speciesData.evolution_chain.url);
            const evolutionData = await evolutionResponse.json();
            
            // 進化チェーンを処理して表示
            const evolutionChain = [];
            let evoData = evolutionData.chain;
            
            // 進化チェーンを配列に変換（複数の進化先に対応）
            function processEvolutions(evoData, currentChain = []) {
                const currentForm = {
                    name: evoData.species.name,
                    url: evoData.species.url
                };
                
                const newChain = [...currentChain, currentForm];
                
                if (evoData.evolves_to.length === 0) {
                    evolutionChain.push(newChain);
                } else {
                    evoData.evolves_to.forEach(evolution => {
                        processEvolutions(evolution, newChain);
                    });
                }
            }
            
            processEvolutions(evoData);

            // 進化チェーンの各ポケモンの情報を取得
            const evolutionPromises = [];
            const processedSpecies = new Set(); // 重複を防ぐためのセット

            evolutionChain.forEach(chain => {
                chain.forEach(pokemon => {
                    if (!processedSpecies.has(pokemon.name)) {
                        processedSpecies.add(pokemon.name);
                        evolutionPromises.push(
                            (async () => {
                                try {
                                    const speciesResponse = await fetch(pokemon.url);
                                    const speciesData = await speciesResponse.json();
                                    
                                    // デフォルトのポケモン情報を取得
                                    const defaultVarietyUrl = speciesData.varieties.find(v => v.is_default).pokemon.url;
                                    const pokemonResponse = await fetch(defaultVarietyUrl);
                                    const pokemonData = await pokemonResponse.json();
                                    
                                    return {
                                        name: speciesData.names.find(name => name.language.name === 'ja')?.name || pokemon.name,
                                        image: pokemonData.sprites.front_default,
                                        id: pokemonData.id,
                                        searchName: pokemon.name
                                    };
                                } catch (error) {
                                    console.error(`Error fetching evolution data for ${pokemon.name}:`, error);
                                    return null;
                                }
                            })()
                        );
                    }
                });
            });

            // 全ての進化形態の情報を取得して表示
            const evolutionResults = (await Promise.all(evolutionPromises)).filter(result => result !== null);
            
            // 進化チェーンをHTMLに変換
            let evolutionHtml = '';
            evolutionChain.forEach((chain, chainIndex) => {
                if (chainIndex > 0) {
                    evolutionHtml += '<div class="evolution-chain-separator">または</div>';
                }
                
                evolutionHtml += '<div class="evolution-chain">';
                chain.forEach((pokemon, index) => {
                    const pokemonInfo = evolutionResults.find(p => p && p.searchName === pokemon.name);
                    if (pokemonInfo) {
                        const isCurrentPokemon = pokemonInfo.id === data.id;
                        evolutionHtml += `
                            ${index > 0 ? '<div class="evolution-arrow">→</div>' : ''}
                            <div class="evolution-card ${isCurrentPokemon ? 'current-pokemon' : ''}" 
                                 onclick="fetchPokemon('${pokemonInfo.searchName}')" 
                                 title="クリックして${pokemonInfo.name}の詳細を表示">
                                <img src="${pokemonInfo.image}" alt="${pokemonInfo.name}" style="width: 100px;">
                                <p>${pokemonInfo.name}</p>
                            </div>
                        `;
                    }
                });
                evolutionHtml += '</div>';
            });

            // 結果を表示
            resultDiv.innerHTML = `
                <div class="pokemon-info">
                    <h2>${japaneseName}</h2>
                    <div class="pokemon-details-header">
                        <p class="pokemon-id">No.${data.id}</p>
                        <div class="pokemon-types">${typeHtml}</div>
                    </div>
                    <div class="sprite-container">
                        <div class="main-sprite">
                            <img src="${data.sprites.other['official-artwork'].front_default || data.sprites.front_default}" alt="${japaneseName}" class="pokemon-image">
                        </div>
                        <div class="sprite-selector">
                            ${allSprites.map((sprite, index) => `
                                <img src="${sprite.url}" 
                                     alt="${sprite.name}" 
                                     class="sprite-thumbnail ${index === 0 ? 'active' : ''}" 
                                     onclick="updateMainSprite(this, '${sprite.url}', [${sprite.types.map(t => `'${t.type.name}'`).join(',')}])">
                            `).join('')}
                        </div>
                    </div>
                    <div class="pokemon-details">
                        <button id="cryButton" onclick="playCry(${data.id})" class="cry-button">
                            <svg viewBox="0 0 24 24">
                                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                            </svg>
                            鳴き声を再生
                        </button>
                        <p>身長: ${data.height / 10}m</p>
                        <p>体重: ${data.weight / 10}kg</p>
                        <p style="font-style: italic;">${japaneseFlavorText}</p>
                    </div>
                </div>
                ${varieties.length > 1 ? `
                <div class="varieties-container">
                    <h3>フォームバリエーション</h3>
                    <div class="varieties">
                        ${varieties.map(variety => `
                            <div class="variety-card ${variety.id === data.id ? 'current-form' : ''}" onclick="fetchPokemon('${variety.name}')">
                                <img src="${variety.sprite}" alt="${variety.japaneseName}">
                                <p>${variety.japaneseName}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>` : ''}
                <div class="evolution-container">
                    <h3>進化チェーン</h3>
                    <div id="evolution-chain">
                        ${evolutionHtml}
                    </div>
                </div>
                <audio id="cryAudio"></audio>
            `;
        }

        // フォームバリエーションを取得
        async function getVarieties(speciesData, currentId) {
            const varieties = [];
            const formPromises = [];
            
            // 特殊なフォーム名のマッピング
            const formNameMapping = {
                'galar': 'ガラルのすがた',
                'alola': 'アローラのすがた',
                'hisui': 'ヒスイのすがた',
                'paldea': 'パルデアのすがた',
                'zen': 'ダルマモード',
                'standard': '通常モード',
                'blade': 'ブレードフォルム',
                'shield': 'シールドフォルム',
                'average': '通常サイズ',
                'small': '小さいサイズ',
                'large': '大きいサイズ',
                'super': '特大サイズ',
                'mega': 'メガ',
                'mega-x': 'メガX',
                'mega-y': 'メガY',
                'gmax': 'キョダイマックス',
                'gigantamax': 'キョダイマックス',
                'eternal': 'ムゲンダイナ',
                'crowned': '王',
                'crowned-sword': '王剣の姿',
                'crowned-shield': '王盾の姿',
                'rapid-strike': '連撃の型',
                'single-strike': '一撃の型',
                'ice': '氷馬',
                'shadow': '影馬',
                'black': '黒馬',
                'white': '白馬',
                'dusk': '黄昏の姿',
                'dawn': '暁の姿',
                'origin': '起源の姿',
                'sky': '天空の姿',
                'therian': '霊獣フォルム',
                'incarnate': '化身フォルム',
                'altered': 'アナザーフォルム',
                'land': '陸の姿',
                'low-key': 'ローキー',
                'amped': 'ハイな姿',
                'noice': '無音の姿',
                'hangry': 'はらぺこもよう',
                'hero': '英雄の姿',
                'resolute': '覚悟の姿',
                'pirouette': 'ステップフォルム',
                'aria': 'ボイスフォルム',
                'ash': 'サトシゲッコウガ',
                'school': '群れの姿',
                'solo': '単独の姿',
                'midnight': '真夜中の姿',
                'midday': '真昼の姿',
                'dusk-mane': '黄昏の鬣',
                'dawn-wings': '暁の翼',
                'ultra': 'ウルトラ',
                'primal': 'ゲンシ',
                'sunshine': 'ポジフォルム',
                'rainy': 'ネガフォルム',
                'snowy': 'ユキノオフォルム',
                'sunny': 'たいようフォルム',
                'rainy': 'あまみずフォルム',
                'snowy': 'ゆきぐもフォルム',
                'attack': 'アタックフォルム',
                'defense': 'ディフェンスフォルム',
                'speed': 'スピードフォルム',
                'sandy': 'すなちフォルム',
                'trash': 'ゴミのミノ',
                'plant': 'くさきのミノ',
                'heat': 'ヒートロトム',
                'wash': 'ウォッシュロトム',
                'frost': 'フロストロトム',
                'fan': 'スピンロトム',
                'mow': 'カットロトム',
                'original': 'オリジナルフォルム',
                'hoenn': 'ホウエンのすがた',
                'sinnoh': 'シンオウのすがた',
                'unova': 'イッシュのすがた',
                'kalos': 'カロスのすがた',
                'alola': 'アローラのすがた',
                'galar': 'ガラルのすがた',
                'paldea': 'パルデアのすがた',
                'male': 'オス',
                'female': 'メス',
                'east': '東の海',
                'west': '西の海',
                'spring': 'はるのすがた',
                'summer': 'なつのすがた',
                'autumn': 'あきのすがた',
                'winter': 'ふゆのすがた',
                'red-striped': '赤しましま',
                'blue-striped': '青しましま',
                'white-striped': '白しましま',
                'yellow': '黄色',
                'orange': 'オレンジ',
                'blue': '青',
                'white': '白',
                'yellow': '黄',
                'indigo': '藍',
                'violet': '紫',
                'red': '赤',
                'green': '緑',
                'blue-plumage': '青い羽',
                'yellow-plumage': '黄色い羽',
                'white-plumage': '白い羽',
                'red-plumage': '赤い羽',
                'totem': 'ぬしポケモン',
                'starter': '最初のパートナー',
                'battle-bond': 'きずなへんげ',
                'disguised': '化けた姿',
                'busted': '正体を現した姿',
                'gorging': '満腹モード',
                'gulping': '空腹モード',
                'confined': '封印されし姿',
                'unbound': '解放されし姿',
                'pau': 'パウスタイル',
                'pom-pom': 'まいまいスタイル',
                'sensu': 'おどりスタイル',
                'baile': 'フラダンススタイル',
                'meteor': '流星の姿',
                'core': 'コア',
                '10': '10%フォルム',
                '50': '50%フォルム',
                'complete': '完全体フォルム',
                'own-tempo': 'マイペース',
                'dusk-form': 'たそがれのすがた',
                'school': '群れの姿',
                'solo': '単独の姿',
                'ice-rider': '白馬の姿',
                'shadow-rider': '黒馬の姿',
                'phony': 'にせもの',
                'antique': 'ほんもの',
                'world': '世界の姿',
                'teal-mask': '碧の仮面',
                'wellspring': 'いどのお面',
                'hearthflame': 'かまどのお面',
                'cornerstone': 'いしずえのお面',
                'f': 'メス',
                'm': 'オス'
            };
            
            // すべてのバリエーションを取得
            for (const variety of speciesData.varieties) {
                formPromises.push(
                    (async () => {
                        try {
                            const response = await fetch(variety.pokemon.url);
                            const pokemonData = await response.json();
                            
                            // 日本語名を取得（バリエーション名がない場合は種族名を使用）
                            let japaneseName = speciesData.names.find(name => name.language.name === 'ja')?.name || pokemonData.name;
                            let formName = '';
                            
                            // フォーム名を追加
                            if (pokemonData.forms.length > 0) {
                                const formResponse = await fetch(pokemonData.forms[0].url);
                                const formData = await formResponse.json();
                                
                                // 日本語のフォーム名を取得
                                const japaneseFormName = formData.form_names.find(name => name.language.name === 'ja')?.name;
                                
                                if (japaneseFormName) {
                                    formName = japaneseFormName;
                                } else {
                                    // 英語名からフォーム名を推測
                                    const formNameEn = pokemonData.forms[0].name;
                                    
                                    // フォーム名を抽出（例: darmanitan-galar-zen → galar-zen）
                                    const baseName = speciesData.name;
                                    let extractedForm = formNameEn.replace(`${baseName}-`, '');
                                    
                                    if (extractedForm !== formNameEn) {
                                        // マッピングを使用してフォーム名を日本語化
                                        const formParts = extractedForm.split('-');
                                        const translatedParts = formParts.map(part => formNameMapping[part] || part);
                                        formName = translatedParts.join('・');
                                    }
                                }
                            }
                            
                            // フォーム名があれば追加
                            if (formName) {
                                japaneseName = `${japaneseName} (${formName})`;
                            }
                            
                            varieties.push({
                                id: pokemonData.id,
                                name: pokemonData.name,
                                japaneseName: japaneseName,
                                sprite: pokemonData.sprites.front_default || 
                                       pokemonData.sprites.other['official-artwork']?.front_default
                            });
                        } catch (error) {
                            console.error(`Error fetching variety ${variety.pokemon.name}:`, error);
                        }
                    })()
                );
            }
            
            await Promise.all(formPromises);
            
            // 図鑑番号順にソート
            varieties.sort((a, b) => a.id - b.id);
            
            return varieties;
        }

        function getTypeInJapanese(type) {
            const typeMap = {
                normal: 'ノーマル',
                fire: 'ほのお',
                water: 'みず',
                electric: 'でんき',
                grass: 'くさ',
                ice: 'こおり',
                fighting: 'かくとう',
                poison: 'どく',
                ground: 'じめん',
                flying: 'ひこう',
                psychic: 'エスパー',
                bug: 'むし',
                rock: 'いわ',
                ghost: 'ゴースト',
                dragon: 'ドラゴン',
                dark: 'あく',
                steel: 'はがね',
                fairy: 'フェアリー'
            };
            return typeMap[type] || type;
        }

        function getAllSprites(sprites, types) {
            const spriteList = [];
            
            // 公式アートワーク（デフォルトとして最初に追加）
            if (sprites.other && sprites.other['official-artwork']?.front_default) {
                spriteList.push({
                    name: '公式アートワーク',
                    url: sprites.other['official-artwork'].front_default,
                    types: types
                });
            }

            // 通常の姿
            if (sprites.front_default) {
                spriteList.push({
                    name: '通常',
                    url: sprites.front_default,
                    types: types
                });
            }

            // メス
            if (sprites.front_female) {
                spriteList.push({
                    name: 'メス',
                    url: sprites.front_female,
                    types: types
                });
            }

            // 色違い
            if (sprites.front_shiny) {
                spriteList.push({
                    name: '色違い',
                    url: sprites.front_shiny,
                    types: types
                });
            }

            // 色違いメス
            if (sprites.front_shiny_female) {
                spriteList.push({
                    name: '色違い(メス)',
                    url: sprites.front_shiny_female,
                    types: types
                });
            }

            return spriteList;
        }

        function updateMainSprite(element, spriteUrl, typesData) {
            // メインスプライトを更新
            document.querySelector('.main-sprite img').src = spriteUrl;

            // アクティブなスプライトのスタイルを更新
            document.querySelectorAll('.sprite-thumbnail').forEach(sprite => {
                sprite.classList.remove('active');
            });
            element.classList.add('active');
            
            // タイプを更新（オーガポンまたはガラルのすがた）
            if (typesData) {
                try {
                    const types = JSON.parse(`[${typesData}]`);
                    const typeHtml = types.map(type => {
                        const typeName = type;
                        const backgroundColor = typeColors[typeName] || '#777';
                        return `<span class="type-badge" style="background-color: ${backgroundColor}">${getTypeInJapanese(typeName)}</span>`;
                    }).join(' ');
                    
                    document.querySelector('.pokemon-types').innerHTML = typeHtml;
                } catch (error) {
                    console.log('タイプの更新に失敗しました:', error);
                }
            }
        }

        async function playCry(pokemonId) {
            const button = document.getElementById('cryButton');
            const audio = document.getElementById('cryAudio');
            
            try {
                button.disabled = true;
                button.innerHTML = `
                    <svg viewBox="0 0 24 24">
                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                    </svg>
                    読み込み中...
                `;

                // PokeAPIから鳴き声のURLを取得
                const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${pokemonId}`);
                const data = await response.json();
                const cryUrl = data.cries?.latest || data.cries?.legacy;
                
                if (!cryUrl) {
                    throw new Error('鳴き声が見つかりません');
                }

                // 鳴き声を読み込んで再生
                audio.src = cryUrl;
                await audio.play();
                
                // 再生が終わったらボタンを元に戻す
                audio.onended = () => {
                    button.disabled = false;
                    button.innerHTML = `
                        <svg viewBox="0 0 24 24">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                        </svg>
                        鳴き声を再生
                    `;
                };

            } catch (error) {
                console.error('鳴き声の再生に失敗しました:', error);
                button.disabled = true;
                button.innerHTML = `
                    <svg viewBox="0 0 24 24">
                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                    </svg>
                    鳴き声なし
                `;
            }
        }

        function getRandomPokemon() {
            // ポケモンの最大数（第9世代まで）
            const maxPokemonId = 1025;
            const randomId = Math.floor(Math.random() * maxPokemonId) + 1;
            fetchPokemon(randomId);
        }
    </script>
</body>
</html>